## やったこと
- インターネットゲートウェイを作成する
- 【動画】NAT ゲートウェイを作成する
- プライベートサブネットにルートテーブルを配置する
- パブリックサブネットにルートテーブルを配置する
- 【動画】【重要！】セキュリティグループの配置戦略について理解する
- 【必修】AWSリソースへのアクセスには表門と裏門があるという話

## 学び
### 【動画】NAT ゲートウェイを作成する
NAT=マジックミラー
- プライベートサブネットから外向きには通信するが、インターネットから内向きの通信はブロックされる。これにより、外からの攻撃を防ぎながら、中からインターネットに通信できる
- IPアドレスを別のIPアドレスに書き換える技術
- グローバルIP = インターネットで使えるユニークアドレス
- プライベートIP = 組織内だけで使えるアドレス
- プライベートIPをグローバルIPに変換するためにNATが必要
- NATのメリット
  - 使えるIPアドレスは有限なので、IPアドレスの節約になる
  - 内部のプライベートIPが外部から見えなくなるので、セキュリティが向上する
  - プライベートIPを自由に設計できるので柔軟性がある
- Wifiもその原理
- AWSのVPCでNATが必要になるケース
  - VPC→パブリックサブネット→Webサーバー→インターネットゲートウェイの構成では、インターネットから直接通信できるが、VPC→プライベートサブネット→DBサーバーの場合はインターネットから通信できない。でも、DBサーバーのOSアップデートをダウンロードしたい場合などには、インターネットとの通信が必要になる。このケースの時にNATが必要になる。
- NATの仕組み
  - どうやってIPアドレスを変換しているのか
  - DBサーバーがパケットを作る
    - パケット : データを小分けにした小包。大きなデータをそのまま送るのは良くないので、小さく分けて送信する。この小さく分けて送っている単位のことをパケットという。
      - パケットの中身
        - ヘッダー : 送信元IP、宛先IP
        - データ : 実際に送りたい情報
    - このパケットがNATインスタンスに届く
    - NATインスタンスがパケットを受け取る→送信元IPアドレスとポート番号を書き換える。この書き換え操作を「SNAT」という。
    - ポート番号で区別するから、ポート番号も書き換えている
  - NATインスタンスは、変換した情報を「コネクショントラッキングテーブル」に記録する。
    - 外部サーバーからレスポンスが返ってくると、NATインスタンスはテーブルを見て逆変換する
- NATゲートウェイとNATインスタンスの違い
  - NATゲートウェイは、マネージドサービスでAWS側が全てを管理してくれる。費用は高いが、高可用性でメンテナンスが不要なのがメリット。
  - NATインスタンスは、自分で管理が必要にはなるが、コストを最適化できたり、カスタマイズ性があるのがメリット。自分でLinuxの設定が必要。
  - iptables
    - サーバーの出入りする通信を制御するツール

NATゲートウェイ作成
- アベイラビリティモード
  - ゾーナル : 1つのAZだけで動く。そのAZで障害が起きると停止する。
  - リージョナル : 複数のAZにまたがって動く。特定のAZで障害起きても継続稼働。

### プライベートサブネットにルートテーブルを配置する

- プライベートサブネットから外向きにインターネットと通信するための道を設定する。
- なぜ必要か？
  - これまでの課題で、VPC作成・サブネット作成（4つ）・インターネットゲートウェイを作成・アタッチ・NATゲートウェイ作成を行ってきた。
  - 次に、プライベートサブネットを外向きのインターネット通信を行うための設定が必要。
  - 作成したプライベートサブネットをルートテーブルに関連づける
- なぜ0.0.0.0/0にNATが重要か？
  - 0.0.0.0/=全てのIPアドレスなので、「VPC内の10.0.0.0/16以外の通信は全部NATへ送信しろ」という意味になる。
  - これがないと、プライベートサブネットがインターネットと通信できない

### パブリックサブネットにルートテーブルを配置する
- パブリックサブネットは、直接インターネットと通信できるから、0.0.0.0/0にインターネットゲートウェイのルートを設定する

### 【動画】【重要！】セキュリティグループの配置戦略について理解する

セキュリティグループとは

- インスタンスごとのファイアウォール
- インバウンドとアウトバウンドがある
  - インバウンド : 外→中の通信を許可/拒否
  - アウトバウンド : 中→外の通信を許可/拒否
- 許可リストは、ホワイトリスト型
- インスタンスレベルで設定する

セキュリティグループ（SG）の最適化戦略

- 同じセキュリティグループをいろんなサービスで使い回すのはダメ
- 1つのサービスに1SG
  - EC2用、ALB用、ECS用、Lamdba用、RDS用などと1つサービスに1SG
  - 冗長化の場合は例外
- 自身にアクセスするサービスのセキュリティグループを許可する
  - インバウンドルール
  - インバウンドルールは、許可するサービスのセキュリティグループのIDを指定する。
  - 各サービスで何を許可しているのかが明確になる
- 名前はサービスごとに具体的に命名する

### 【必修】AWSリソースへのアクセスには表門と裏門があるという話

- AWSリソースと疎通する際に、セキュリティグループで許可するべきなのか、それともIAM権限を付与すべきなのかを正しく判断できるようにする
- 表門
  - HTTPS, SSH, PostgreSQL, MySQLなど
  - セキュリティグループが必要
- 裏門
  - AWS API経由で行われる操作。AWS内部で閉じた通信。CLI, SDK, Terraform, CloudFormation, CDKなど
  - セキュリティグループの許可はいらないが、IAMの権限が必要

## 感想

今までNATの概念が全然理解できていなかったので、IPアドレスを別のIPアドレスに書き換えることで、プライベートIPをグローバルIPに変換する仕組みで、DBサーバーのOSアップデートや外部APIへのアクセスなど、プライベートサブネットからインターネットへ通信する際に必要な仕組みだということを知れた。

また、NATがどうやってIPアドレスを変換しているのかも、パケットがNATに届き、送信元IPとポート番号を書き換える（SNAT）し、コネクショントラッキングテーブルに記録していくのも勉強になった。

NATゲートウェイを作成しただけではだめで、ルートテーブルを作成して、0.0.0.0/0 → NAT を設定する必要があるのも勉強になった。

そして、セキュリティグループについてもインバウンドルールとアウトバウンドルールがあり、自身にアクセスするサービスのセキュリティグループIDを許可するという最適化戦略も勉強になった。