## やったこと
- データベース用のセキュリティグループを作成
- DB サブネットグループを作成
- RDSインスタンスを作成
- EventBridge Schedulerでコスト削減を図る

## 学び

### DB サブネットグループを作成

#### RDSサブネットグループとは？
- RDSを配置できるサブネットの組み合わせを定義したもの
- RDSを作成するときに、どのサブネットにおくかを指定する必要がある。しかし、RDSは高可用性のために複数のAZに配置できる
  - → 1つのサブネットだけでなく、複数のサブネットを指定する必要がある
  - → それをまとめたものが「サブネットグループ」
- 役割
  - 高可用性のため
    - どこかのAZで障害が発生したときに自動的に切り替わる（フェイルオーバー）
    - これを実現するために、複数のAZのサブネットを指定する必要がある
  - ネットワーク環境の制御
    - RDSをプライベートサブネットに配置
    - インターネットから直接アクセスさせない
    - 特定のサブネット（ECSなど）からのみアクセス可能
- 課題でやること
  - RDSサブネットグループを作成
  - VPCを選択
  - サブネットを選択
- 課題のポイント
  - 最低2つのAZのサブネットが必要
  - プライベートサブネットを選択する
  - RDS作成時にこのサブネットグループを指定する

### パラメータグループを作成

#### パラメータグループとは

- データベースの動作を制御する設定値の集まり
  - 文字コード、タイムゾーン、メモリ割り当て、接続数の上限、ログの設定など
- なぜ、カスタムパラメータグループが必要なのか
  - デフォルトパラメータグループだと、AWSが用意した初期設定になってしまい、変更できない
  - 一方、カスタムパラメータグループは、自分で作成できて、設定を自由に変更できる
- 例
  - 文字コード : utf8md4
  - タイムゾーン : Asia/Tokyo
  - max_connections : 接続数の上限を増やす
  - slow_query_log : 遅いクエリをログに記録
- サブネットグループとパラメータグループの違い
  - サブネットグループ
    - ネットワークの設定、どこに配置するか
  - パラメータグループ
    - DBの設定、どう動作するか

### RDSインスタンスを作成

#### RDSのクラス
- データベースサーバのスペックを決める設定
- クラス名の読み方
  - db.t3.micro
    - db : DBインスタンスの意味
  - t3 : 世代（t3, t4g, r5, r6gなど）
  - micro : サイズ（micro, small, medium, large…）
- インスタンスファミリー（種類）
  - t系（t3, t4g）: 低コスト、小規模
  - m系（m5, m6g）: バランス
  - r系（r5, r6g）: メモリ重視、大規模DB、キャッシュ多め

バースト可能とは
- 普段は低いスペックで動き、必要なタイミングだけ一時的に高い性能を出せる仕組み
- 各インスタンスにはベースラインが決められていて、常に使えるCPU性能はベースラインまでになる。CPUを使わない時間があると、クレジットが貯まり、ベースラインを超えたCPUを使う時はそのクレジットを消費することで対応できる

### EventBridge Schedulerでコスト削減を図る

#### EventBridge Scheduler用のIAMロールを作成
- 許可ポリシー
  - RDS起動/停止
  - cp-scheduler-cost-cutter-policy-stg
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "RDSStartStopInstances",
      "Effect": "Allow",
      "Action": [
        "rds:StopDBInstance",
        "rds:StartDBInstance"
      ],
      "Resource": "*"
    }
  ]
}
```
- IAMロール作成
- cp-scheduler-cost-cutter-stg
- カスタム信頼ポリシー
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "scheduler.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```
- 作成後の状態
  - IAMロール : cp-scheduler-cost-cutter-stg
  - 信頼ポリシー : EventBridge Schedulerが使用可能
  - 許可ポリシー : cp-scheduler-cost-cutter-policy-stg
  - RDS起動/停止

#### スケジュールグループを作成
- 粒度 : プロダクト単位で作成することが多い
- cost-cutter-stg

#### RDSインスタンスを停止するScheduleを作成

- 毎日深夜2時にRDSインスタンスを自動停止するスケジュール
- stop-db-instance-cp-stg
- スケジュールグループ : cost-cutter-stg
- 頻度 : 定期的なスケジュール
- タイムゾーン : UTC+09:00 Asia/Tokyo
- スケジュールの種類 : cronベースのスケジュール
- cron式 : 分(0) / 時(2) / 日() / 月() / 曜日() / 年(*) → 毎日深夜2時に実行
- フレックスタイムウィンドウ : オフ（指定時間から実行を許容する時間幅なので、今回のケースだと多少ずれても問題ないためオフにする）
- ターゲット :
  - ターゲットAPI : Amazon RDS
  - 操作 : StopDBInstance
  - DbInstanceIdentifier : cloud-pratica-stg
- アクセス許可 : cp-scheduler-cost-cutter-stgを選択

#### RDSインスタンスを起動するScheduleを作成

- 毎週月曜日の深夜1時45分にRDSインスタンスを起動するスケジュール
- start-db-instance-cp-stg
- 45 / 1 / ? / * / MON / *

## 感想
### 難しかったこと・つまづいたこと
EventBridge Schedulerの設定をどの値に何を設定するのかを調査しながら行った。RDSを削除/起動するスケジューラーを設定するということはイメージできたが、具体的に何を設定するのかが最初イメージがわかなかった。
EventBridge Scheduler用のIAMロールを作成するにあたり、RDSを起動/停止を許可するポリシーを作成し、IAMロールにカスタム信頼ポリシーでschedulerのポリシーを設定するというフローを調べながら行えたのはよかった。

### 理解できたこと・腹落ちしたこと
RDSサブネットグループを作成することで、複数のAZに配置することができ、高可用性を維持することができるという点がなるほどなと思った。また、プライベートサブネットを選択することで、インターネットから直接アクセスさせない構成にできることも理解できた。

DBのパラメータグループで、DBの設定値を色々設定できるということも理解できた。

IAMロール（誰が使うか）とIAMポリシー（何ができるか）の役割や、2つを組み合わせて権限を設定する流れを復習できた。

### 次にやりたいこと・疑問点
- RDSのバックアップでどうやっているのだろうか
- 実務でEC2インスタンスのクラスを選ぶときにどんなこと考えて決めるのだろうか
- slow_query_logを検知した後の改善フローってどんな感じにやっているのだろうか
- EventBridge Schedulerのスケジュールが失敗したときは、どうやって通知を受け取るのだろうか
